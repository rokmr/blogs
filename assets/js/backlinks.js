/**
 * Backlinks Component
 * Shows which posts link to the current post
 * Uses client-side parsing since Jekyll doesn't have native backlinks
 */

// Cache for post data
let postsCache = null;

async function initBacklinks() {
    const backlinksContainer = document.getElementById('backlinks');
    if (!backlinksContainer) return;

    const currentUrl = window.location.pathname;

    try {
        // Fetch all posts data
        const posts = await fetchPostsData();

        // Find posts that link to the current post
        const backlinks = findBacklinks(posts, currentUrl);

        if (backlinks.length === 0) {
            backlinksContainer.innerHTML = `
        <p class="backlinks-empty">No other posts link to this page yet.</p>
      `;
            return;
        }

        // Render backlinks
        backlinksContainer.innerHTML = backlinks.map(post => `
      <a href="${post.url}" class="backlink-item">
        <span class="backlink-title">${post.title}</span>
        <span class="backlink-context">${post.context || ''}</span>
      </a>
    `).join('');

    } catch (error) {
        console.error('Failed to load backlinks:', error);
        backlinksContainer.innerHTML = `<p class="backlinks-error">Failed to load backlinks</p>`;
    }
}

/**
 * Fetch posts data from a JSON endpoint
 * This requires a posts.json file generated by Jekyll
 */
async function fetchPostsData() {
    if (postsCache) return postsCache;

    try {
        const response = await fetch('/blogs/posts.json');
        if (!response.ok) throw new Error('Posts data not found');
        postsCache = await response.json();
        return postsCache;
    } catch (error) {
        console.error('Could not fetch posts data:', error);
        return [];
    }
}

/**
 * Find posts that contain links to the current URL
 */
function findBacklinks(posts, currentUrl) {
    const backlinks = [];

    // Normalize current URL
    const normalizedCurrent = normalizeUrl(currentUrl);

    for (const post of posts) {
        if (normalizeUrl(post.url) === normalizedCurrent) continue;

        // Check if this post links to the current page
        if (post.links && post.links.some(link => normalizeUrl(link) === normalizedCurrent)) {
            backlinks.push({
                title: post.title,
                url: post.url,
                date: post.date,
                context: post.excerpt || ''
            });
        }
    }

    return backlinks;
}

/**
 * Normalize URL for comparison
 */
function normalizeUrl(url) {
    return url
        .replace(/^https?:\/\/[^/]+/, '')
        .replace(/\/$/, '')
        .replace(/\/index\.html$/, '')
        .toLowerCase();
}

// Export for global access
if (typeof window !== 'undefined') {
    window.initBacklinks = initBacklinks;
}
